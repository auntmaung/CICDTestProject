version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      # your backend likely connects to host "db" on port 5432
    depends_on:
      - db

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend

  # PRIMARY DATABASE (same as your old "db" service, just extended)
  db:
    image: postgres:14
    container_name: db-primary
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - pgdata:/var/lib/postgresql/data
      # tablespaces for fragmented gigger_logs partitions
      - /opt/ts_logs_2023:/var/lib/postgresql/ts_logs_2023
      - /opt/ts_logs_2024:/var/lib/postgresql/ts_logs_2024
      # export location for CSV files (Option 3 / Athena)
      - /opt/datalake:/opt/datalake
    ports:
      - "5432:5432"  # primary exposed to host

  # REPLICA DATABASE (new container, used only for replication screenshots)
    db-replica:
      image: postgres:14
      container_name: db-replica
      environment:
        POSTGRES_DB: mydb
        POSTGRES_USER: user        # not used much, but required by image
        POSTGRES_PASSWORD: password
        PGDATA: /var/lib/postgresql/data
      volumes:
        - pgdata_replica:/var/lib/postgresql/data
        - ./db-init/init-replica.sh:/init-replica.sh:ro
      depends_on:
        - db
      ports:
        - "5433:5432"
      entrypoint: ["/bin/bash", "/init-replica.sh"]

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend

volumes:
  pgdata:
  pgdata_replica:
